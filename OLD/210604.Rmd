---
title: "Non Differentiality Test"
author: "Giorgio Limoncella"
date: "4/6/2021"
output: 
  rmdformats::downcute:
  toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Agenda

- Data generation
- Asymmetry
- Relaxing the assumption
- Next Steps 


## Data generation

Example: algorithm A in the non-exposed group

```{r example_data_gen, echo=TRUE , eval=FALSE}
A_TP_ne=rep(1, SE_A_ne*length(Y_1_ne))
A_FN_ne=rep(0, (1-SE_A_ne)*length(Y_1_ne))
A_FP_ne=rep(1, (1-SP_A_ne)*length(Y_0_ne))
A_TN_ne=rep(0, (SP_A_ne)*length(Y_0_ne))

```


![Fixed Data](fig_1.png)



## Asymmetry 

**So far**: SE_AintB is fixed -> SE_B depends on SE_A

```{r parameters, include = TRUE, echo = TRUE, eval=FALSE}
## starting parameters
N = 20000; prop_exp= 0.2
pi_ne = 0.05; risk = 2
pi_e = pi_ne*risk
    
## validation indices: exposed
SE_A_e=  c(0.3, 0.4, 0.5, 0.6, 0.7)
SE_AintB_e = 0.1
SP_A_e = 0.99
SP_B_e=0.95
    
## validation indices: non-exposed
SE_A_ne=0.5
SE_AintB_ne = 0.1
SP_A_ne = 0.99
SP_B_ne=0.95
```

```{r library, include = FALSE, echo = FALSE}
library("ggplot2")
library("ggthemes")
library("ggrepel")
```

```{r graph_simmetry_SEB_non_fixed, echo=FALSE}
cat("\n")

sample=c(rep("100", 5), rep("250", 5), rep("500", 5))
sensitivity_exposed=rep(c( 0.3, 0.4, 0.5, 0.6, 0.7),3)
power=c(0.804, 0.335, 0.050, 0.123, 0.492,
        0.997, 0.682, 0.061, 0.228, 0.874,
        1.000, 0.968, 0.060, 0.450, 0.998)



DF=data.frame(sensitivity_exposed, power, sample)
ix_label <- c(2, 4, 7, 9, 12, 14)
DF$label <- ""
DF$label[ix_label] <- c(0.335, 0.123, 0.682, 0.228, 0.968, 0.450)



ggplot(DF, aes(x=sensitivity_exposed, y=power, col=sample, label=label))+
        geom_point()+
        geom_line(size=1)+
        theme_hc()+
        ylab("")+
        scale_color_manual(values = c("deeppink", "skyblue3", "yellow3"))+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)+
        geom_vline(xintercept = 0.4, lty= 2, col = "slategrey")+
        geom_vline(xintercept = 0.6, lty= 2, col = "slategrey")+
        geom_label_repel(aes(label = label),
                         box.padding   = 0.35, 
                         point.padding = 0.5,
                         segment.color = 'slategrey')
cat("\n")
```


- Fixing SE_B: 

SE_B = 0.8

```{r parameters_2, include = TRUE, echo = TRUE}
## starting parameters
N = 20000; prop_exp= 0.2
pi_ne = 0.05; risk = 2
pi_e = pi_ne*risk

## validation indices: exposed
SE_A_e=c(0.3, 0.4, 0.5, 0.6, 0.7)
SE_B_e=0.8
SE_AintB_e = SE_A_e + SE_B_e - 1
SP_A_e = 0.99
SP_B_e=0.95
SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))

## validation indices: non-exposed
SE_A_ne = 0.5
SE_B_ne = 0.8
SE_AintB_ne = SE_A_ne + SE_B_ne - 1
SP_A_ne = 0.99
SP_B_ne = 0.95
SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```



```{r graph_simmetry_SEB_fixed, echo=FALSE}
cat("\n")

sample=c(rep("100", 5), rep("250", 5), rep("500", 5))
sensitivity_exposed=rep(c( 0.3, 0.4, 0.5, 0.6, 0.7),3)
power=c(0.679, 0.172, 0.047, 0.244, 0.600,
        0.983, 0.356, 0.034, 0.538, 0.954,
        1,0.721,0.036,0.855,1)



DF=data.frame(sensitivity_exposed, power, sample)
ix_label <- c(2, 4, 7, 9, 12, 14)
DF$label <- ""
DF$label[ix_label] <- c(0.172, 0.244, 0.356, 0.538, 0.721, 0.855)




ggplot(DF, aes(x=sensitivity_exposed, y=power, col=sample, label=label))+
        geom_point()+
        geom_line(size=1)+
        theme_hc()+
        ylab("")+
        scale_color_manual(values = c("deeppink", "skyblue3", "yellow3"))+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)+
        geom_vline(xintercept = 0.4, lty= 2, col = "slategrey")+
        geom_vline(xintercept = 0.6, lty= 2, col = "slategrey")+
        geom_label_repel(aes(label = label),
                         box.padding   = 0.35, 
                         point.padding = 0.5,
                         segment.color = 'slategrey')
cat("\n")
```

- **Variability**: SE_B = 0.7
```{r parameters_3, include = TRUE, echo = TRUE}
## starting parameters
N = 20000; prop_exp= 0.2
pi_ne = 0.05; risk = 2
pi_e = pi_ne*risk

## validation indices: exposed
SE_A_e=c(0.3, 0.4, 0.5, 0.6, 0.7)
SE_B_e=0.7
SE_AintB_e = SE_A_e + SE_B_e - 1
SP_A_e = 0.99
SP_B_e=0.95
SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))

## validation indices: non-exposed
SE_A_ne = 0.5
SE_B_ne = 0.7
SE_AintB_ne = SE_A_ne + SE_B_ne - 1
SP_A_ne = 0.99
SP_B_ne = 0.95
SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```


```{r graph_simmetry_SEB_fixed_3, echo=FALSE}
cat("\n")

sample=c(rep("1", 5), rep("2", 5), rep("3", 5))
sensitivity_exposed=rep(c( 0.3, 0.4, 0.5, 0.6, 0.7),3)
power=c(1, 0.783, 0.018, 0.829, 1,
        1, 0.797, 0.025, 0.848, 1,
        1, 0.789, 0.021, 0.852, 1)



DF=data.frame(sensitivity_exposed, power, sample)
ix_label <- c(2, 4, 7, 9, 12, 14)
DF$label <- ""
DF$label[ix_label] <- c(0.783, 0.829, 0.797, 0.848, 0.789, 0.852)




ggplot(DF, aes(x=sensitivity_exposed, y=power, col=sample, label=label))+
        geom_point()+
        geom_line(size=1)+
        theme_hc()+
        ylab("")+
        scale_color_manual(values = c("deeppink", "skyblue3", "yellow3"))+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)+
        geom_vline(xintercept = 0.4, lty= 2, col = "slategrey")+
        geom_vline(xintercept = 0.6, lty= 2, col = "slategrey")+
        geom_label_repel(aes(label = label),
                         box.padding   = 0.35, 
                         point.padding = 0.5,
                         segment.color = 'slategrey')
cat("\n")
```

## Relaxing the assumption

$SE_{A \cup B}$ different from 1, but with non-differential error. 
<br>

- **Prevalence** not available: 


\begin{equation}

\pi = \tfrac{P_A \times PPV_A}{SE_{A \cup B}} + \tfrac{P_B \times PPV_B}{SE_{A \cup B}} - \tfrac{P_{A \cap B} \times PPV_{A \cap B}}{SE_{A \cup B}}

\end{equation}

- **Risk Ratio** available:

\begin{equation}

\tfrac{\pi^E}{\pi^{\bar{E}}} = \tfrac{1/SE_{A \cup B}^E}{1/SE_{A \cup B}^{\bar{E}}} * \tfrac{P_A^E \times PPV_A^E + P_B^E \times PPV_B^E - P_{A \cap B}^E \times PPV_{A \cap B}^E}{P_A^\bar{E} \times PPV_A^\bar{E} + P_B^\bar{E} \times PPV_B^\bar{E} - P_{A \cap B}^\bar{E} \times PPV_{A \cap B}^\bar{E}}

\end{equation}

- **Test Statistic**:

<<<<<<< HEAD
to be completed ...
=======
To be completed ...
>>>>>>> 0b921848d4d63b3b289b317f31f8ad4e7ae193ce

<br>
<br>
<br>

<<<<<<< HEAD
- if the statistic is still usable: 
=======
- if the statistic is still usable:

>>>>>>> 0b921848d4d63b3b289b317f31f8ad4e7ae193ce

```{r graph_no_assumption, echo=FALSE}
cat("\n")

sensitivity_exposed=c( 0.3, 0.4, 0.5, 0.6, 0.7)
power=c(0.995, 0.591, 0.043, 0.632, 0.997)

DF=data.frame(sensitivity_exposed, power, sample)
ix_label <- c(2, 4)
DF$label <- ""
DF$label[ix_label] <- c(0.591, 0.632)




ggplot(DF, aes(x=sensitivity_exposed, y=power, label=label))+
        geom_point(col="deeppink")+
        geom_line(size=1, col="deeppink")+
        theme_hc()+
        ylab("")+
        scale_color_manual(values = c("deeppink", "skyblue3", "yellow3"))+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)+
        geom_vline(xintercept = 0.4, lty= 2, col = "slategrey")+
        geom_vline(xintercept = 0.6, lty= 2, col = "slategrey")+
        geom_label_repel(aes(label = label),
                         box.padding   = 0.35, 
                         point.padding = 0.5,
                         segment.color = 'slategrey')
cat("\n")
```

- point 1
```{r 1, include = TRUE, echo = TRUE}
## validation indices: exposed
SE_A_e=0.3
SE_B_e=0.6
SE_AintB_e = 0.1
SP_A_e = 0.99
SP_B_e=0.95
SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))

## validation indices: non-exposed
SE_A_ne = 0.5
SE_B_ne = 0.4
SE_AintB_ne = 0.1
SP_A_ne = 0.99
SP_B_ne = 0.95
SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```

- point 2
```{r 2, include = TRUE, echo = TRUE}
  ## validation indices: exposed
  SE_A_e=0.4
  SE_B_e=0.5
  SE_AintB_e = 0.1
  SP_A_e = 0.99
  SP_B_e=0.95
  SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))
  
  ## validation indices: non-exposed
  SE_A_ne = 0.5
  SE_B_ne = 0.4
  SE_AintB_ne = 0.1
  SP_A_ne = 0.99
  SP_B_ne = 0.95
  SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```

- point 3
```{r 3, include = TRUE, echo = TRUE}
  ## validation indices: exposed
  SE_A_e=0.5
  SE_B_e=0.4
  SE_AintB_e = 0.1
  SP_A_e = 0.99
  SP_B_e=0.95
  SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))
  
  ## validation indices: non-exposed
  SE_A_ne = 0.5
  SE_B_ne = 0.4
  SE_AintB_ne = 0.1
  SP_A_ne = 0.99
  SP_B_ne = 0.95
  SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```

- point 4
```{r 4, include = TRUE, echo = TRUE}
  ## validation indices: exposed
  SE_A_e=0.6
  SE_B_e=0.3
  SE_AintB_e = 0.1
  SP_A_e = 0.99
  SP_B_e=0.95
  SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))
  
  ## validation indices: non-exposed
  SE_A_ne = 0.5
  SE_B_ne = 0.4
  SE_AintB_ne = 0.1
  SP_A_ne = 0.99
  SP_B_ne = 0.95
  SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```

- point 5
```{r 5, include = TRUE, echo = TRUE}
  ## validation indices: exposed
  SE_A_e=0.7
  SE_B_e=0.2
  SE_AintB_e = 0.1
  SP_A_e = 0.99
  SP_B_e=0.95
  SP_AintB_e = 1-((1-SP_A_e)*(1-SP_B_e))
  
  ## validation indices: non-exposed
  SE_A_ne = 0.5
  SE_B_ne = 0.4
  SE_AintB_ne = 0.1
  SP_A_ne = 0.99
  SP_B_ne = 0.95
  SP_AintB_ne = 1-((1-SP_A_ne)*(1-SP_B_ne))
```

## Next steps

**??** to be filled
