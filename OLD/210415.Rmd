---
title: "Non Differentiality Test"
output: 
  rmdformats::downcute:
  toc: TRUE
---


 
# Test Statistc development:

\begin{align}
SE_A &= \tfrac{P_A \times PPV_A}{\pi}\\
\\

&= \tfrac{P_A \times PPV_A}{P_A \times PPV_A + 
                           P_B \times PPV_B -
                           P_{A \cap B} \times PPV_{A \cap B}}\\
                           \\

&=  \tfrac{1}{\frac{P_A \times PPV_A}{P_A \times PPV_A}+
                            \frac{P_B \times PPV_B}{P_A \times PPV_A}-
                            \frac{P_{A \cap B} \times PPV_{A \cap B}}{P_A \times PPV_A}}\\
                            \\
                            
&= \frac{1}{1 +
            \frac{P_B \times PPV_B}{P_A \times PPV_A}-
            \frac{P_{A \cap B} \times PPV_{A \cap B}}{P_A \times PPV_A}}\\
            
\end{align}

then $\frac{SE_A^E}{SE_A^{\bar E}}$ is equal to 1, if and only if:

\begin{equation}
\frac{P^E_B}{P^E_A} \times \frac{PPV^E_B}{PPV^E_A} -
\frac{P^E_{A\cap B}}{P^E_A} \times \frac{PPV^E_{A\cap B}}{PPV^E_A} -
\frac{P^\bar{E}_B}{P^\bar{E}_A} \times \frac{PPV^\bar{E}_B}{PPV^\bar{E}_A} +
\frac{P^\bar{E}_{A\cap B}}{P^\bar{E}_A} \times \frac{PPV^\bar{E}_{A\cap B}}{PPV^\bar{E}_A} = 0
\end{equation}


when the intersection is empty, the **test statistic** is equal to:

\begin{equation}
\frac{P^E_B}{P^E_A} \times \frac{PPV^E_B}{PPV^E_A} -
\frac{P^\bar{E}_B}{P^\bar{E}_A} \times \frac{PPV^\bar{E}_B}{PPV^\bar{E}_A} 
\end{equation}

when the intersection is not empty, the **test statistic** is equal to:

\begin{equation}
\frac{P^E_B}{P^E_A} \times \frac{PPV^E_B}{PPV^E_A} -
\frac{P^E_{A\cap B}}{P^E_A} \times \frac{PPV^E_{A\cap B}}{PPV^E_A} -
\frac{P^\bar{E}_B}{P^\bar{E}_A} \times \frac{PPV^\bar{E}_B}{PPV^\bar{E}_A} +
\frac{P^\bar{E}_{A\cap B}}{P^\bar{E}_A} \times \frac{PPV^\bar{E}_{A\cap B}}{PPV^\bar{E}_A} 
\end{equation}

# Parameters
```{r 1, include=TRUE}
## starting parameters
N = 20000; prop_exp= 0.2
pi_ne = 0.05; risk = 2
pi_e = pi_ne*risk
    
## validation indices: exposed
SE_A_e=0.7
SE_AintB_e = 0.1
SP_A_e = 0.99
SP_B_e=0.95
    
## validation indices: non-exposed
SE_A_ne=0.5
SE_AintB_ne = 0.1
SP_A_ne = 0.99
SP_B_ne=0.95
```

```{r 2, include=FALSE}
  prop_e=prop_exp
  E = c(rep(0,(1-prop_e)*N), rep(1,prop_e*N))
  
  Y = ifelse(E==1, sapply(E,function(pe){rbinom(1,1,pi_e)}),
             sapply(E,function(pne){rbinom(1,1,pi_ne)}))
  
  dati = cbind(E,Y)
```

```{r 3, include=FALSE}

  A = NA
  A = ifelse(Y==1 & E==1, apply(dati, 1, function(SEe){rbinom(1, 1, SE_A_e)}),
        ifelse(Y==1 & E==0, apply(dati, 1, function(SEne){rbinom(1, 1, SE_A_ne)}), 
          ifelse(Y==0 & E==1, apply(dati, 1, function(FPe){rbinom(1, 1, 1-SP_A_e)}), 
            ifelse(Y==0 & E==0, apply(dati, 1, function(FPne){rbinom(1, 1, 1-SP_A_ne)}), A))))
  
  B = NA
  B = ifelse(Y==1 & A==0, apply(dati, 1, function(SE1){rbinom(1, 1, 1)}),
        ifelse(Y==1 & A==1 & E==0, apply(dati, 1, function(SEne){rbinom(1, 1, SE_AintB_ne)}),
          ifelse(Y==1 & A==1 & E==1, apply(dati, 1, function(SEe){rbinom(1, 1, SE_AintB_e)}),
            ifelse(Y==0 & E==1, apply(dati, 1, function(FPe){rbinom(1, 1, 1-SP_B_e)}), 
              ifelse(Y==0 & E==0, apply(dati, 1, function(FPne){rbinom(1, 1, 1-SP_B_ne)}), B)))))
  
  C = NA
  C = A*B

```

```{r boot, include=FALSE}
  sample_size=100
  # Sets A==1 and B==1
  n=nb=sample_size
  
  P_A_e = sum(A==1&E==1)/sum(E==1)
  P_A_ne = sum(A==1&E==0)/sum(E==0)
  
  P_B_e = sum(B==1&E==1)/sum(E==1)
  P_B_ne = sum(B==1&E==0)/sum(E==0)
  
  P_A =  sum(A==1)/N
  P_B = sum(B==1)/N
  
  c1 = P_B_e/P_A_e; c2 = P_B_ne/P_A_ne
  
  matrix_A = as.data.frame(cbind(Y[A==1],A[A==1],E[A==1]))
  matrix_B = as.data.frame(cbind(Y[B==1],B[B==1],E[B==1]))
  colnames(matrix_A)=c("Y","A","E")
  colnames(matrix_B)=c("Y","B","E")
  
  
  #bootstrap_power
  
  PPV_A_e = PPV_A_ne = PPV_B_e = PPV_B_ne = NULL
  n1=n2=n3=n4=NULL
  nboot=500
  nsam = 1000
  tx_boot=c()
  
  TX_boot=TX_boot2=matrix(0,nsam,nboot)
  PPV_A_e0=PPV_A_ne0=PPV_B_e0=PPV_B_ne0=matrix(0,nsam,nboot)
  PPV_A_e2=PPV_A_ne2=PPV_B_e2=PPV_B_ne2=matrix(0,nsam,nboot)
  

```

# Bootstrap

- **sample_size_a** = 100 : size of the original sample (A)

- **sample_size_b** = 100 : size of the original sample (B)

- **na** = 100:  size of the bootstrap sample of A

- **nb** = 100: size of the bootstrap sample of A

- **nboot** = 500: number of statistics calculated in order to perform **one** test

- **nsam** = 1000: number of test performed in order to compute the power


```{r bootinclude, include=TRUE, eval=F}
for(i in 1:nsam){

  sam_Ya1 = matrix_A[sample(nrow(matrix_A),sample_size_a),]
  sam_Yb1 = matrix_B[sample(nrow(matrix_B),sample_size_b),]

  for(j in 1:nboot){

    sam_Ya_boot = sam_Ya1[sample(nrow(sam_Ya1), na, replace = TRUE),]
    sam_Yb_boot = sam_Yb1[sample(nrow(sam_Yb1), nb, replace = TRUE),]

    PPV_A_e0[i,j] = (sum(sam_Ya_boot$A==1&sam_Ya_boot$Y==1&sam_Ya_boot$E==1))/
      (sum(sam_Ya_boot$A==1&sam_Ya_boot$E==1))

    PPV_B_e0[i,j] = (sum(sam_Yb_boot$B==1&sam_Yb_boot$Y==1&sam_Yb_boot$E==1))/
      (sum(sam_Yb_boot$B==1&sam_Yb_boot$E==1))

    PPV_A_ne0[i,j] = (sum(sam_Ya_boot$A==1&sam_Ya_boot$Y==1&sam_Ya_boot$E==0))/
      (sum(sam_Ya_boot$A==1&sam_Ya_boot$E==0))

    PPV_B_ne0[i,j] = (sum(sam_Yb_boot$B==1&sam_Yb_boot$Y==1&sam_Yb_boot$E==0))/
      (sum(sam_Yb_boot$B==1&sam_Yb_boot$E==0))


    TX_boot[i,j] = c1*PPV_B_e2[i,j]/PPV_A_e2[i,j]-c2*PPV_B_ne2[i,j]/PPV_A_ne2[i,j] -
      c3*max(PPV_B_e2[i,j],PPV_A_e2[i,j])/PPV_A_e2[i,j] +
      c4*max(PPV_B_ne2[i,j],PPV_A_ne2[i,j])/PPV_A_ne2[i,j]


  }}
```
# Extraction from a binomial

```{r 3_print , include=TRUE,  eval=F}

  A = NA
  A = ifelse(Y==1 & E==1, apply(dati, 1, function(SEe){rbinom(1, 1, SE_A_e)}),
        ifelse(Y==1 & E==0, apply(dati, 1, function(SEne){rbinom(1, 1, SE_A_ne)}), 
          ifelse(Y==0 & E==1, apply(dati, 1, function(FPe){rbinom(1, 1, 1-SP_A_e)}), 
            ifelse(Y==0 & E==0, apply(dati, 1, function(FPne){rbinom(1, 1, 1-SP_A_ne)}), A))))
  
  B = NA
  B = ifelse(Y==1 & A==0, apply(dati, 1, function(SE1){rbinom(1, 1, 1)}),
        ifelse(Y==1 & A==1 & E==0, apply(dati, 1, function(SEne){rbinom(1, 1, SE_AintB_ne)}),
          ifelse(Y==1 & A==1 & E==1, apply(dati, 1, function(SEe){rbinom(1, 1, SE_AintB_e)}),
            ifelse(Y==0 & E==1, apply(dati, 1, function(FPe){rbinom(1, 1, 1-SP_B_e)}), 
              ifelse(Y==0 & E==0, apply(dati, 1, function(FPne){rbinom(1, 1, 1-SP_B_ne)}), B)))))
  
  C = NA
  C = A*B

```

## Variability
```{r bootPLOOTbin, include=TRUE, echo=FALSE}
suppressWarnings( library(ggplot2, quietly = TRUE))
suppressWarnings( library(ggthemes, quietly = TRUE))
suppressWarnings( library(ggrepel, quietly = TRUE))
suppressWarnings( library(gridExtra))


power=c(0.42, 0.033, 0.198, 0.754, 0.075, 0.928, 0.999, 0.679, 0.980, 1, 1, 1, 1, 1, 1)

sensibility=c(rep(0.55, 5), rep(0.65, 5), rep(0.8, 5))

df=data.frame(power, sensibility)
cat("\n")

plot2=ggplot(df, aes(sensibility, power, col=sensibility))+
    theme_igray()+
    geom_point()
plot2
cat("\n")

```

# Fixed
```{r 4, include=TRUE} 

## Population: Non-Exposed
N_non_exposed=(1-prop_exp)*N
E_0=rep(0,N_non_exposed)
    
    
Y_0_ne=rep(0,N_non_exposed*(1-pi_ne))
Y_1_ne=rep(1,N_non_exposed*pi_ne)
Y_ne=c(Y_1_ne, Y_0_ne)
    
## Population: Exposed
N_exposed=(prop_exp)*N
E_1=rep(1,N_exposed)
Y_0_e=rep(0,N_exposed*(1-pi_e))
Y_1_e=rep(1,N_exposed*pi_e)
Y_e=c(Y_1_e, Y_0_e)
    
## Population: aggregated 
Y=c(Y_e, Y_ne)
E=c(E_1, E_0)
data=data.frame(E,Y)

## Algorithm: A non-exposed
A_TP_ne=rep(1, SE_A_ne*length(Y_1_ne))
A_FN_ne=rep(0, (1-SE_A_ne)*length(Y_1_ne))
A_TN_ne=rep(0, (SP_A_ne)*length(Y_0_ne))
A_FP_ne=rep(1, (1-SP_A_ne)*length(Y_0_ne))
    
A_ne=c(A_TP_ne, A_FN_ne, A_TN_ne, A_FP_ne)
    
## Algorithm: B non-exposed
B_TP_int_ne=rep(1, SE_AintB_ne*length(Y_1_ne))
B_FN_ne=rep(0, (SE_A_ne-SE_AintB_ne)*length(Y_1_ne)) 
B_TP_ne=rep(1, (1-SE_A_ne)*length(Y_1_ne))
B_TN_ne=rep(0, (SP_B_ne)*length(Y_0_ne))
B_FP_ne=rep(1, (1-SP_B_ne)*length(Y_0_ne))
    
B_ne=c(B_TP_int_ne, B_FN_ne, B_TP_ne, B_TN_ne, B_FP_ne)
    
## Algorithm: A exposed
A_TP_e=rep(1, SE_A_e*length(Y_1_e))
A_FN_e=rep(0, (1-SE_A_e)*length(Y_1_e))
A_TN_e=rep(0, (SP_A_e)*length(Y_0_e))
A_FP_e=rep(1, (1-SP_A_e)*length(Y_0_e))
    
A_e=c(A_TP_e, A_FN_e, A_TN_e, A_FP_e)
    
## Algorithm: B exposed
B_TP_int_e=rep(1, SE_AintB_e*length(Y_1_e))
B_FN_e=rep(0, (SE_A_e-SE_AintB_e)*length(Y_1_e))
B_TP_e=rep(1, (1-SE_A_e)*length(Y_1_e))
B_TN_e=rep(0, (SP_B_e)*length(Y_0_e))
B_FP_e=rep(1, (1-SP_B_e)*length(Y_0_e))
    
B_e=c(B_TP_int_e, B_FN_e, B_TP_e, B_TN_e, B_FP_e)
    
## Algorithm: aggregated 
A=c(A_e, A_ne)
B=c(B_e, B_ne)

## Algorithm: C (intersection)
C=ifelse(A==1&B==1, 1 , 0)
    
data=data.frame(E, Y, A, B, C)
    
```


## Variability

```{r 6, include=TRUE, echo=FALSE}
power=c(0.04, 0.248, 0.759, 0.987, 1, 
        0.047, 0.272, 0.805, 0.986, 1.000,
        0.055, 0.271, 0.778, 0.988, 1.000,
        0.045, 0.296, 0.781, 0.991, 1.000,
        0.063, 0.271, 0.759, 0.982, 1.000,
        0.050, 0.308, 0.759, 0.991, 1.000,
        0.049, 0.282, 0.780, 0.981, 0.999,
        0.046, 0.286, 0.797, 0.992, 0.999,
        0.036, 0.259, 0.759, 0.989, 1.000,
        0.040, 0.257, 0.769, 0.990, 1.000)

sensitivity_exposed=(rep(c(0.5, 0.6, 0.7, 0.8, 0.9),10))

number=c(rep(1, 5), rep(2, 5), rep(3, 5), rep(4, 5), rep(5, 5),
         rep(6, 5), rep(7, 5), rep(8, 5), rep(9, 5), rep(10, 5) )

DF=data.frame( sensitivity_exposed, power, number)


cat("\n")

plot1=ggplot(DF, aes(x=sensitivity_exposed, y=power, col=sensitivity_exposed))+
        geom_point()+
        #geom_line(size=1)+
        theme_igray()+
        ylab("")+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)+
        geom_vline(xintercept = 0.4, lty= 2, col = "slategrey")

plot1

#grid.arrange(plot1, plot2, nrow=2)
cat("\n")
cat("\n")
cat("\n")

```


# Results
Power of bootstrap test for non-differentiality for three different sample sizes 

```{r 7, include=TRUE, echo=FALSE}
cat("\n")

sample=c(rep("100", 9), rep("250", 9), rep("500", 9))
sensitivity_exposed=rep(c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9),3)
power=c(0.998, 0.991, 0.804, 0.335, 0.050, 0.123, 0.492, 0.883, 0.989,
        1.000, 1.000, 0.997, 0.682, 0.061, 0.228, 0.874, 1.000, 1.000,
        1.000, 1.000, 1.000, 0.968, 0.060, 0.450, 0.998, 1.000, 1.000)



DF=data.frame(sensitivity_exposed, power, sample)
ix_label <- c(4, 6, 13, 15, 22, 24)
DF$label <- ""
DF$label[ix_label] <- c(0.335, 0.123, 0.682, 0.228, 0.968, 0.450)



library("ggplot2")
library("ggthemes")
library("ggrepel")


cat("\n")

ggplot(DF, aes(x=sensitivity_exposed, y=power, col=sample, label=label))+
        geom_point()+
        geom_line(size=1)+
        theme_igray()+
        ylab("")+
        scale_color_manual(values = c("deeppink", "skyblue3", "yellow3"))+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)


cat("\n")
cat("\n")
cat("\n")
cat("\n")


cat("\n")
cat("\n")
cat("\n")
```



# To check

## Correction 

```{r 8, include=TRUE, echo=TRUE, eval=F}

  for(i in 1:nsam){
    
    sam_Ya_boot = sam_Ya1[sample(nrow(sam_Ya1), n, replace = TRUE),]
    sam_Yb_boot = sam_Yb1[sample(nrow(sam_Yb1), nb, replace = TRUE),]
    
    for(j in 1:nboot){
      
      PPV_B_e2[i,j] = ifelse( PPV_B_e0[i,j]>0 & (!is.na(PPV_B_e0[i,j])) & PPV_B_e0[i,j] != Inf, 
                              PPV_B_e0[i,j],  1/(2*sum(sam_Yb_boot$B==1&sam_Yb_boot$E==1)))
      
      PPV_A_e2[i,j] = ifelse( PPV_A_e0[i,j]>0 & (!is.na(PPV_A_e0[i,j])) & PPV_A_e0[i,j] != Inf,
                              PPV_A_e0[i,j],  1/(2*sum(sam_Ya_boot$A==1&sam_Ya_boot$E==1)))
      
      PPV_B_ne2[i,j] = ifelse( PPV_B_ne0[i,j]>0 & (!is.na(PPV_B_ne0[i,j])) & PPV_B_ne0[i,j] != Inf, 
                               PPV_B_ne0[i,j],  1/(2*sum(sam_Yb_boot$B==1&sam_Yb_boot$E==0)))
      
      PPV_A_ne2[i,j] = ifelse( PPV_A_ne0[i,j]>0 & (!is.na(PPV_A_ne0[i,j])) & PPV_A_ne0[i,j] != Inf,
                               PPV_A_ne0[i,j],  1/(2*sum(sam_Ya_boot$A==1&sam_Ya_boot$E==0)))
      
      TX_boot2[i,j] = c1*PPV_B_e2[i,j]/PPV_A_e2[i,j]-c2*PPV_B_ne2[i,j]/PPV_A_ne2[i,j]
      
    }
  }

```

## Asymmetry

```{r 9, include=TRUE, echo=FALSE}

cat("\n")
cat("\n")
cat("\n")
cat("\n")
cat("\n")
cat("\n")

ggplot(DF, aes(x=sensitivity_exposed, y=power, col=sample, label=label))+
        geom_point()+
        geom_line(size=1)+
        theme_igray()+
        ylab("")+
        scale_color_manual(values = c("deeppink", "skyblue3", "yellow3"))+
        scale_x_continuous( breaks=sensitivity_exposed, labels=sensitivity_exposed)+
        geom_vline(xintercept = 0.4, lty= 2, col = "slategrey")+
        geom_label_repel(aes(label = label),
                         box.padding   = 0.35, 
                         point.padding = 0.5,
                         segment.color = 'slategrey')
cat("\n")


```